{% extends "textgen/base.html" %}
{% load static %}
{% block title %}Chat - TextGenerationDelta{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="chat-container">
        <!-- Sidebar for Chat History -->
        <div class="sidebar">
            <h4>Chat History</h4>
            <ul class="chat-history-list">
                {% for chat in chats %}
                    <li data-chat-id="{{ chat.id }}">
                        <div class="chat-title">{{ chat.prompt|truncatechars:30 }}</div>
                        <div class="chat-date">{{ chat.timestamp|date:"M d, H:i" }}</div>
                    </li>
                {% empty %}
                    <li><em>No chats yet.</em></li>
                {% endfor %}
            </ul>
            <!-- Settings Button -->
            <button class="settings-btn" id="openSettingsBtn">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </button>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <div id="chatHistory">
                {% if chats %}
                    {% for chat in chats %}
                        <div class="message-container mb-3">
                            <!-- User Message -->
                            <div class="message-user d-flex justify-content-end mb-1">
                                <div class="message-bubble bg-primary text-white p-3 rounded">
                                    <div class="message-content">{{ chat.prompt }}</div>
                                </div>
                            </div>
                            <!-- AI Message -->
                            <div class="message-ai d-flex justify-content-start mb-1">
                                <div class="message-bubble bg-light border p-3 rounded">
                                    <div class="message-content">{{ chat.response }}</div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="welcome-message">
                        <h2>Welcome to TextGenerationDelta</h2>
                        <p>Send a message to start chatting with your local AI.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Input Area at the Bottom -->
            <div class="input-area">
                <form id="chatForm" method="post">
                    {% csrf_token %}
                    <div class="input-group">
                        <textarea class="form-control" id="promptInput" name="prompt" rows="1" placeholder="Type your message..." required></textarea>
                        <button class="btn btn-primary" type="submit" id="sendButton" title="Send">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                    <!-- Loading Indicator (Initially Hidden) -->
                    <div id="loadingIndicator" class="d-none">
                        <div class="spinner"></div>
                        <span>AI is thinking...</span>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="settings-modal">
    <div class="settings-modal-content">
        <div class="settings-modal-header">
            <h4 class="settings-modal-title">AI Settings</h4>
            <button class="settings-modal-close" id="closeSettingsBtn">&times;</button>
        </div>
        <div class="settings-modal-body">
            <form id="settingsForm">
                <div class="settings-form-group">
                    <label for="roleInput" class="settings-form-label">Role:</label>
                    <input type="text" id="roleInput" class="settings-form-input" value="user">
                </div>
                <div class="settings-form-group">
                    <label for="seedInput" class="settings-form-label">Seed:</label>
                    <input type="number" id="seedInput" class="settings-form-input" value="-1">
                </div>
                <div class="settings-form-group">
                    <label for="temperatureInput" class="settings-form-label">Temperature:</label>
                    <input type="number" step="0.01" min="0" max="2" id="temperatureInput" class="settings-form-input" value="0.7">
                </div>
                <div class="settings-form-group">
                    <label for="maxTokensInput" class="settings-form-label">Max Tokens:</label>
                    <input type="number" min="1" id="maxTokensInput" class="settings-form-input" value="200">
                </div>
                <div class="settings-form-group">
                    <label for="modelPathInput" class="settings-form-label">Model Path:</label>
                    <input type="text" id="modelPathInput" class="settings-form-input" value="./qwen2.5b.gguf">
                </div>
                <div class="settings-form-group">
                    <label for="topPInput" class="settings-form-label">Top P:</label>
                    <input type="number" step="0.01" min="0" max="1" id="topPInput" class="settings-form-input" value="1.0">
                </div>
                <div class="settings-form-group">
                    <label for="topKInput" class="settings-form-label">Top K:</label>
                    <input type="number" min="0" id="topKInput" class="settings-form-input" value="50">
                </div>
            </form>
        </div>
        <div class="settings-modal-footer">
            <button type="button" class="settings-modal-btn settings-modal-btn-secondary" id="cancelSettingsBtn">Cancel</button>
            <button type="button" class="settings-modal-btn settings-modal-btn-primary" id="saveSettingsBtn">Save</button>
        </div>
    </div>
</div>

<script src="{% static 'scripts/chat-enhanced.js' %}"></script>

{% endblock %}